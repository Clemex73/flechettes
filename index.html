<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Fl√©chettes ‚Äì Scoreboard</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#121212">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="icon" type="image/png" href="icon-192.png">

  <style>
    :root{
      --cream1:#fbf3e7;
      --cream2:#f1e5d4;
      --ink:#141414;
      --ink2:rgba(20,20,20,.72);
      --line:rgba(20,20,20,.14);
      --panel:rgba(255,255,255,.70);
      --panel2:rgba(255,255,255,.52);
      --shadow: 0 14px 40px rgba(0,0,0,.12);
      --radius:18px;

      --red:#c82924;
      --red2:#b61f1a;

      --ok:#1e8e3e;
      --warn:#b07212;

      --tap:44px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--ink);
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(200,41,36,.08), transparent 55%),
        radial-gradient(1000px 700px at 90% 15%, rgba(20,20,20,.06), transparent 60%),
        linear-gradient(180deg, var(--cream1), var(--cream2));
      overflow:hidden; /* ‚úÖ aucun scroll page */
      height: 100dvh;
    }

    .wrap{
      height: 100dvh;
      max-width: 1100px;
      margin:0 auto;
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex: 0 0 auto;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .brand img{
      width: 34px; height: 34px;
      border-radius: 10px;
      box-shadow: 0 10px 24px rgba(0,0,0,.10);
    }
    header h1{
      margin:0;
      font-size: 16px;
      letter-spacing: .2px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 60vw;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.55);
      box-shadow: 0 10px 24px rgba(0,0,0,.10);
      font-size: 12px;
      color: var(--ink2);
      white-space: nowrap;
    }

    .card{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* ---- SETUP ---- */
    #setup{
      padding: 12px;
      flex: 1 1 auto;
      min-height: 0;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden; /* ‚úÖ pas de scroll */
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .col{ flex: 1 1 260px; min-width: 0; }

    label{
      display:block;
      font-size: 12px;
      color: var(--ink2);
      margin: 8px 0 6px;
      font-weight: 700;
    }

    select,input,button{
      width:100%;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid rgba(20,20,20,.16);
      background: rgba(255,255,255,.72);
      color: var(--ink);
      outline:none;
      min-height: var(--tap);
    }

    button{
      cursor:pointer;
      font-weight: 900;
      border-color: transparent;
      background: linear-gradient(180deg, var(--red), var(--red2));
      color: #fff;
      box-shadow: 0 12px 26px rgba(200,41,36,.22);
      transition: transform .06s ease, filter .15s ease;
    }
    button:hover{ filter: brightness(1.03); }
    button:active{ transform: translateY(1px); }
    button.secondary{
      background: rgba(255,255,255,.60);
      border: 1px solid rgba(20,20,20,.18);
      box-shadow: none;
      color: var(--ink);
      font-weight: 850;
    }
    button.danger{
      background: linear-gradient(180deg, #111, #2a2a2a);
      box-shadow: 0 12px 26px rgba(0,0,0,.18);
    }
    button:disabled{ opacity:.5; cursor:not-allowed; transform:none; }

    .muted{ color: var(--ink2); font-size: 12px; }
    .hr{ height:1px; background: rgba(20,20,20,.12); margin: 8px 0; }
    .actionsRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .actionsRow > *{ flex: 1 1 160px; }

    /* ---- GAME LAYOUT (fixed, no vertical scroll) ---- */
    #game{
      display:none;
      flex: 1 1 auto;
      min-height: 0;
      padding: 10px;
      overflow:hidden; /* ‚úÖ pas de scroll */
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .gameTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex: 0 0 auto;
    }

    .miniActions{
      display:flex;
      gap:8px;
      flex-wrap:nowrap;
      max-width: 360px;
    }
    .miniActions button{ width:auto; padding: 10px 12px; }

    /* Players strip (horizontal only) */
    .mobilePlayers{
      display:flex;
      gap:8px;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 2px;
      flex: 0 0 auto;
    }
    .mobilePlayers::-webkit-scrollbar{ height: 0; }

    .mpCard{
      flex: 0 0 auto;
      min-width: 120px;
      border-radius: 16px;
      border:1px solid rgba(20,20,20,.14);
      background: rgba(255,255,255,.62);
      padding: 8px 10px;
    }
    .mpCard.active{
      border-color: rgba(200,41,36,.35);
      background: rgba(200,41,36,.10);
      outline: 2px solid rgba(200,41,36,.18);
    }
    .mpTop{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:center;
      font-size: 11px;
      color: var(--ink2);
      font-weight: 800;
    }
    .mpName{
      font-size: 12px;
      font-weight: 950;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 92px;
      color: var(--ink);
    }
    .mpScore{ font-size: 18px; font-weight: 980; margin-top: 4px; }

    .turnBanner{
      flex: 0 0 auto;
      padding: 9px 10px;
      border-radius: 16px;
      border:1px solid rgba(20,20,20,.14);
      background: rgba(255,255,255,.55);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .turnBanner b{ font-size: 13px; }

    /* Tabs fixed */
    .tabs{
      flex: 0 0 auto;
      display:flex;
      gap:6px;
      border:1px solid rgba(20,20,20,.14);
      background: rgba(255,255,255,.55);
      border-radius: 999px;
      padding: 5px;
    }
    .tabs button{
      width:auto;
      flex: 1;
      padding: 10px 8px;
      border-radius: 999px;
      background: transparent;
      border:1px solid transparent;
      box-shadow:none;
      color: var(--ink2);
      font-weight: 950;
      min-height: 40px;
    }
    .tabs button.active{
      background: rgba(200,41,36,.12);
      border-color: rgba(200,41,36,.20);
      color: var(--ink);
    }

    /* Panels: fixed height, no scroll */
    .mobilePanels{
      flex: 1 1 auto;
      min-height: 0;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .panel{
      display:none;
      flex: 1 1 auto;
      min-height: 0;
      overflow:hidden; /* ‚úÖ aucun scroll */
    }
    .panel.active{ display:block; }

    /* Console fixed layout inside */
    .console{
      height: 100%;
      display:flex;
      flex-direction:column;
      gap:8px;
      padding: 10px;
      overflow:hidden; /* ‚úÖ */
      border: none;
      background: transparent;
      box-shadow: none;
    }

    .readout{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      flex: 0 0 auto;
    }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .chip{
      padding: 6px 9px;
      border-radius: 999px;
      border:1px solid rgba(20,20,20,.14);
      background: rgba(255,255,255,.55);
      font-size: 11px;
      color: var(--ink2);
      font-weight: 800;
    }
    .chip b{ color: var(--ink); font-weight: 980; }

    .topBtns button{
      width:auto;
      padding: 10px 10px;
      min-height: 40px;
    }

    .dartsRow{
      flex: 0 0 auto;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }
    .dartSlot{
      border-radius: 14px;
      border:1px solid rgba(20,20,20,.14);
      background: rgba(255,255,255,.55);
      padding: 8px;
      min-height: 46px;
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      overflow:hidden;
    }
    .dartSlot .label{ font-size: 11px; font-weight: 950; }
    .dartSlot .pts{ font-size: 13px; font-weight: 980; }
    .dartSlot.empty{ opacity:.55; }

    .totalBox{
      flex: 0 0 auto;
      border-radius: 14px;
      border:1px solid rgba(200,41,36,.22);
      background: rgba(200,41,36,.10);
      padding: 8px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .totalBox b{ font-size: 12px; }
    .totalBox .total{ font-size: 20px; font-weight: 980; }

    .selector{
      flex: 0 0 auto;
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .toggles{
      display:flex; gap:6px;
      background: rgba(255,255,255,.55);
      border:1px solid rgba(20,20,20,.14);
      border-radius: 999px;
      padding: 4px;
    }
    .toggles button{
      width:auto;
      padding: 8px 10px;
      border-radius: 999px;
      background: transparent;
      border:1px solid transparent;
      box-shadow:none;
      font-weight: 950;
      color: var(--ink2);
      min-height: 36px;
    }
    .toggles button.active{
      background: rgba(200,41,36,.12);
      border-color: rgba(200,41,36,.20);
      color: var(--ink);
    }

    .quickRow{
      flex: 0 0 auto;
      display:flex; gap:6px; flex-wrap:wrap;
    }
    .miniBtn{
      width:auto;
      padding: 9px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,.60);
      border:1px solid rgba(20,20,20,.16);
      box-shadow:none;
      color: var(--ink);
      font-weight: 950;
      min-height: 40px;
    }

    /* Numbers take remaining space (no scroll) */
    .numbers{
      flex: 1 1 auto;
      min-height: 0;
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 6px;
      overflow:hidden; /* ‚úÖ */
    }
    .numBtn{
      border-radius: 14px;
      background: rgba(255,255,255,.60);
      border:1px solid rgba(20,20,20,.16);
      box-shadow:none;
      font-size: 13px;
      font-weight: 980;
      padding: 0;
      height: 100%;
      min-height: 0;
      color: var(--ink);
    }

    /* ‚úÖ bouton valider cach√© (score imm√©diat) */
    .applyRow{ display:none; }

    /* Cricket fixed: if too long, we shrink text instead of scrolling */
    .cricketWrap{
      height:100%;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:hidden;
    }
    .cricketTitle{ display:flex; justify-content:space-between; gap:8px; align-items:center; flex:0 0 auto; }
    .cricketTitle b{ font-size: 13px; }
    .cricketGrid{
      flex: 1 1 auto;
      min-height: 0;
      border-radius: 16px;
      border:1px solid rgba(20,20,20,.14);
      overflow:hidden;
      background: rgba(255,255,255,.50);
      display:flex;
      flex-direction:column;
    }
    .cHeaderRow{
      display:grid;
      grid-template-columns: 64px 1fr;
      border-bottom:1px solid rgba(20,20,20,.12);
      background: rgba(255,255,255,.55);
      flex:0 0 auto;
    }
    .cHeaderLeft{
      padding: 8px 8px;
      font-size: 11px;
      color: var(--ink2);
      border-right:1px solid rgba(20,20,20,.12);
      font-weight: 900;
    }
    .cHeaderRight{ display:grid; }
    .cHeaderCell{
      padding: 8px 6px;
      font-size: 11px;
      color: var(--ink2);
      font-weight: 900;
      text-align:center;
      border-right:1px solid rgba(20,20,20,.10);
      white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
    }
    .cHeaderCell:last-child{ border-right:none; }

    .cBody{
      flex: 1 1 auto;
      min-height: 0;
      display:flex;
      flex-direction:column;
    }
    .cRow{
      display:grid;
      grid-template-columns: 64px 1fr;
      border-bottom:1px solid rgba(20,20,20,.10);
      background: rgba(255,255,255,.35);
      flex: 1 1 auto; /* each row shares available space */
      min-height: 0;
    }
    .cRow:last-child{ border-bottom:none; }
    .cTarget{
      padding: 6px 8px;
      font-weight: 980;
      display:flex; align-items:center; justify-content:space-between; gap:6px;
      border-right:1px solid rgba(20,20,20,.10);
      background: rgba(255,255,255,.45);
      font-size: 12px;
    }
    .openTag{
      font-size: 9px;
      padding: 3px 7px;
      border-radius: 999px;
      border:1px solid rgba(20,20,20,.14);
      background: rgba(255,255,255,.55);
      color: var(--ink2);
      font-weight: 900;
      white-space: nowrap;
    }
    .openTag.open{
      border-color: rgba(200,41,36,.22);
      background: rgba(200,41,36,.10);
      color: var(--ink);
    }
    .openTag.allclosed{
      border-color: rgba(30,142,62,.22);
      background: rgba(30,142,62,.10);
      color: var(--ok);
    }

    .cCells{ display:grid; gap:0; }
    .cCell{
      padding: 6px 4px;
      border-right:1px solid rgba(20,20,20,.08);
      display:flex; align-items:center; justify-content:center;
      font-weight: 950;
      color: var(--ink2);
      font-size: 13px;
      min-height: 0;
    }
    .cCell:last-child{ border-right:none; }
    .cCell.active{ background: rgba(200,41,36,.10); color: var(--ink); }
    .cCell.closed{ color: var(--ok); }
    .marks{ letter-spacing: 1px; }

    /* History fixed: show last 8 lines only (no scroll) */
    .historyWrap{
      height:100%;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:hidden;
    }
    .historyWrap b{ font-size: 13px; }
    .history{
      flex: 1 1 auto;
      min-height: 0;
      border-radius: 16px;
      border:1px solid rgba(20,20,20,.14);
      background: rgba(255,255,255,.50);
      overflow:hidden; /* ‚úÖ */
      display:flex;
      flex-direction:column;
    }
    .hist-item{
      padding: 8px 10px;
      border-bottom:1px solid rgba(20,20,20,.10);
      font-size: 12px;
      line-height: 1.25;
      flex: 1 1 auto;
      min-height: 0;
      display:flex;
      flex-direction:column;
      justify-content:center;
      overflow:hidden;
    }
    .hist-item:last-child{ border-bottom:none; }

    .win{ color: var(--ok); font-weight: 980; }
    .bust{ color: var(--warn); font-weight: 980; }

    @media (max-width: 380px){
      :root{ --tap: 40px; }
      .numbers{ grid-template-columns: repeat(4, minmax(0, 1fr)); }
      .mpCard{ min-width: 110px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img src="icon-192.png" alt="CLEMEX">
        <h1>CLEMEX Fl√©chettes</h1>
      </div>
      <div class="badge" id="topBadge">Pr√™t</div>
    </header>

    <!-- SETUP -->
    <div id="setup" class="card">
      <div class="row">
        <div class="col">
          <label>Mode de jeu</label>
          <select id="mode">
            <option value="x01">X01 (301 / 501 / 701) ‚Äì bust</option>
            <option value="countup">Count Up ‚Äì addition</option>
            <option value="cricket">Cricket (20‚Üí15 + Bull)</option>
          </select>

          <label>Score de d√©part (X01)</label>
          <select id="startScore">
            <option value="301">301</option>
            <option value="501" selected>501</option>
            <option value="701">701</option>
          </select>

          <label>Nombre de joueurs</label>
          <select id="numPlayers">
            <option value="1">1</option>
            <option value="2" selected>2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
          </select>

          <div class="muted" style="margin-top:8px">
            S/D/T + num√©ro. En <b>Cricket</b>, seuls 15‚Äì20 + Bull comptent.
          </div>
        </div>

        <div class="col">
          <label>Noms des joueurs</label>
          <div id="names"></div>
          <div class="muted" style="margin-top:8px">Vide = ‚ÄúJoueur 1‚Äù, etc.</div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="actionsRow">
        <button id="startBtn">D√©marrer</button>
        <button id="loadBtn" class="secondary">Reprendre la derni√®re partie</button>
      </div>
    </div>

    <!-- GAME -->
    <div id="game" class="card">
      <div class="gameTop">
        <div class="badge" id="modeBadge">Mode</div>
        <div class="miniActions">
          <button id="newGameBtn" class="secondary">Nouvelle</button>
          <button id="resetBtn" class="danger">Reset</button>
        </div>
      </div>

      <!-- Compact players strip -->
      <div class="mobilePlayers" id="mobilePlayers"></div>

      <div class="turnBanner">
        <b id="turnLabel">‚Äî</b>
        <span class="muted" id="smallHint">‚å´=Retour ‚Ä¢ Esc=Effacer ‚Ä¢ Annuler=Undo</span>
      </div>

      <!-- Tabs -->
      <div class="tabs" id="tabs" role="tablist" aria-label="Vue">
        <button type="button" id="tabInput" class="active">Saisie</button>
        <button type="button" id="tabCricket">Cricket</button>
        <button type="button" id="tabHistory">Historique</button>
      </div>

      <!-- Panels -->
      <div class="mobilePanels" id="mobilePanels">
        <div class="panel active" id="panelInput">
          <!-- Console -->
          <div class="console" id="consoleDesktop">
            <div class="readout">
              <div class="chips">
                <span class="chip">Fl√©chettes : <b id="dartsCount">0</b>/3</span>
                <span class="chip">Mode : <b id="multLabel">S</b></span>
              </div>
              <div class="chips topBtns">
                <button id="undoBtn" class="secondary" style="width:auto">Annuler</button>
                <button id="backBtn" class="secondary" style="width:auto">‚Üê</button>
                <button id="clearBtn" class="secondary" style="width:auto">Effacer</button>
              </div>
            </div>

            <div class="dartsRow" id="dartsRow"></div>

            <div class="totalBox">
              <b>Total du tour</b>
              <div class="total" id="turnTotal">0</div>
            </div>

            <div class="selector">
              <div class="toggles" role="tablist" aria-label="Multiplicateur">
                <button id="mS" class="active" type="button">S</button>
                <button id="mD" type="button">D</button>
                <button id="mT" type="button">T</button>
              </div>
              <div class="muted" id="hint">S = simple (x1)</div>
            </div>

            <div class="quickRow">
              <button class="miniBtn" id="missBtn" type="button">MISS</button>
              <button class="miniBtn" id="sbBtn" type="button">SB</button>
              <button class="miniBtn" id="dbBtn" type="button">DB</button>
            </div>

            <div class="numbers" id="numbers"></div>

            <div class="applyRow">
              <button id="applyBtn">Valider le tour</button>
            </div>
          </div>
        </div>

        <div class="panel" id="panelCricket">
          <div class="cricketWrap">
            <div class="cricketTitle">
              <b>üéØ Cible Cricket</b>
              <span class="muted" style="font-size:11px">15‚Üí20 + Bull</span>
            </div>

            <div class="cricketGrid">
              <div class="cHeaderRow" id="cHeaderRow"></div>
              <div class="cBody" id="cGrid"></div>
            </div>

            <div class="muted" id="cricketHint" style="font-size:11px">Le mode Cricket n‚Äôest pas s√©lectionn√©.</div>
          </div>
        </div>

        <div class="panel" id="panelHistory">
          <div class="historyWrap">
            <b>Historique</b>
            <div class="muted" style="font-size:11px">Derniers tours (fixe)</div>
            <div class="history" id="history"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const setupEl = $("setup");
  const gameEl = $("game");

  const topBadge = $("topBadge");
  const modeBadge = $("modeBadge");

  const modeEl = $("mode");
  const startScoreEl = $("startScore");
  const numPlayersEl = $("numPlayers");
  const namesWrap = $("names");

  const startBtn = $("startBtn");
  const loadBtn = $("loadBtn");

  const mobilePlayersEl = $("mobilePlayers");

  const historyEl = $("history");
  const turnLabelEl = $("turnLabel");

  const cHeaderRowEl = $("cHeaderRow");
  const cGridEl = $("cGrid");
  const cricketHintEl = $("cricketHint");

  const applyBtn = $("applyBtn");
  const undoBtn = $("undoBtn");
  const resetBtn = $("resetBtn");
  const newGameBtn = $("newGameBtn");

  // Dart console
  const dartsCountEl = $("dartsCount");
  const dartsRowEl = $("dartsRow");
  const turnTotalEl = $("turnTotal");
  const backBtn = $("backBtn");
  const clearBtn = $("clearBtn");

  // Mult toggles
  const mS = $("mS"), mD = $("mD"), mT = $("mT");
  const multLabelEl = $("multLabel");
  const hintEl = $("hint");

  // quick
  const missBtn = $("missBtn"), sbBtn = $("sbBtn"), dbBtn = $("dbBtn");
  const numbersEl = $("numbers");

  // Tabs/panels
  const tabInput = $("tabInput");
  const tabCricket = $("tabCricket");
  const tabHistory = $("tabHistory");
  const panelInput = $("panelInput");
  const panelCricket = $("panelCricket");
  const panelHistory = $("panelHistory");

  const STORAGE_KEY = "flechettes_app_state_v6_fixed_noscroll_instant";
  const CRICKET_TARGETS = [20,19,18,17,16,15,"B"];
  const BULL_POINTS_PER_MARK = 25;

  let state = null;
  let mobileView = "input"; // input | cricket | history

  function renderNameInputs() {
    const n = Number(numPlayersEl.value);
    namesWrap.innerHTML = "";
    for (let i=0;i<n;i++) {
      const inp = document.createElement("input");
      inp.type = "text";
      inp.placeholder = `Joueur ${i+1}`;
      inp.id = `name_${i}`;
      inp.style.marginBottom = "8px";
      namesWrap.appendChild(inp);
    }
  }

  function createCricketMarks(numPlayers){
    const marks = [];
    for (let i=0;i<numPlayers;i++){
      const obj = {};
      CRICKET_TARGETS.forEach(t => obj[String(t)] = 0);
      marks.push(obj);
    }
    return marks;
  }

  function createGameFromSetup() {
    const mode = modeEl.value;
    const n = Number(numPlayersEl.value);
    const startScore = Number(startScoreEl.value);

    const names = [];
    for (let i=0;i<n;i++) {
      const v = ($(`name_${i}`)?.value || "").trim();
      names.push(v || `Joueur ${i+1}`);
    }

    const players = names.map(name => ({
      name,
      score: (mode === "x01") ? startScore : 0,
      turns: 0,
      isWinner: false
    }));

    const st = {
      mode,
      startScore,
      players,
      current: 0,
      finished: false,
      history: [],
      undoStack: [],
      currentDarts: [],
      mult: 1
    };

    if (mode === "cricket"){
      st.cricket = { marks: createCricketMarks(n) };
    }
    return st;
  }

  function saveState() {
    if (!state) return;
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ ...state, mobileView }));
  }

  function loadState() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return null;
    try {
      const obj = JSON.parse(raw);
      if (obj && obj.mobileView) mobileView = obj.mobileView;
      delete obj.mobileView;
      return obj;
    } catch {
      return null;
    }
  }

  function showSetup(){ setupEl.style.display="block"; gameEl.style.display="none"; topBadge.textContent="Pr√™t"; }
  function showGame(){ setupEl.style.display="none"; gameEl.style.display="flex"; }

  function fmtMode(mode){ return mode === "x01" ? "X01" : (mode === "countup" ? "Count Up" : "Cricket"); }

  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function pushUndoSnapshot(){
    state.undoStack.unshift(JSON.parse(JSON.stringify({
      players: state.players,
      current: state.current,
      finished: state.finished,
      history: state.history,
      currentDarts: state.currentDarts,
      mult: state.mult,
      cricket: state.cricket
    })));
    if (state.undoStack.length > 80) state.undoStack.pop();
  }

  function setFinished(winnerIndex){
    state.finished = true;
    state.players.forEach((p, i) => p.isWinner = (i===winnerIndex));
  }

  function nextPlayer(){
    if (state.finished) return;
    state.current = (state.current + 1) % state.players.length;
  }

  function setMult(m){
    state.mult = m;
    mS.classList.toggle("active", m===1);
    mD.classList.toggle("active", m===2);
    mT.classList.toggle("active", m===3);
    multLabelEl.textContent = m===1?"S":m===2?"D":"T";
    hintEl.textContent = m===1?"S = simple (x1)" : m===2?"D = double (x2)" : "T = triple (x3)";
    saveState();
  }

  function getTotal(){
    return (state.currentDarts||[]).reduce((s,d)=>s+(d.points||0),0);
  }

  function updateConsole(){
    const darts = state.currentDarts || [];
    dartsCountEl.textContent = darts.length;

    dartsRowEl.innerHTML = "";
    for (let i=0;i<3;i++){
      const d = darts[i];
      const slot = document.createElement("div");
      slot.className = "dartSlot" + (d ? "" : " empty");
      slot.innerHTML = d
        ? `<div><div class="muted" style="font-size:10px">Fl√©chette ${i+1}</div><div class="label">${escapeHtml(d.label)}</div></div>
           <div class="pts">${d.points}</div>`
        : `<div><div class="muted" style="font-size:10px">Fl√©chette ${i+1}</div><div class="label">‚Äî</div></div>
           <div class="pts"> </div>`;
      dartsRowEl.appendChild(slot);
    }

    turnTotalEl.textContent = getTotal();

    const full = darts.length >= 3 || state.finished;
    numbersEl.querySelectorAll("button").forEach(b => b.disabled = full || b.dataset.disabled === "1");
    missBtn.disabled = full;
    sbBtn.disabled = full;
    dbBtn.disabled = full;

    backBtn.disabled = (state.undoStack.length === 0) || state.finished;
    clearBtn.disabled = darts.length === 0 || state.finished;

    // bouton valider inutile
    if (applyBtn) applyBtn.disabled = true;

    undoBtn.disabled = state.undoStack.length === 0;

    const p = state.players[state.current];
    modeBadge.textContent = `${fmtMode(state.mode)} ‚Ä¢ ${state.mode==="x01" ? "D√©part "+state.startScore : (state.mode==="cricket" ? "20‚Üí15 + Bull" : "Addition")}`;
    topBadge.textContent = state.finished ? "Partie termin√©e" : `√Ä toi : ${p.name}`;
  }

  // ‚úÖ SCORE IMM√âDIAT : chaque dart modifie le score tout de suite (X01 / CountUp)
  function addDart(label, points, meta=null){
    if (!state || state.finished) return;
    if (state.currentDarts.length >= 3) return;

    // snapshot AVANT la fl√©chette (pour retour)
    pushUndoSnapshot();

    const idx = state.current;
    const p = state.players[idx];
    const before = p.score;

    state.currentDarts.push({label, points, meta});

    if (state.mode === "x01"){
      const after = before - points;
      if (after < 0){
        // bust => on annule la fl√©chette et le snapshot
        state.currentDarts.pop();
        state.undoStack.shift();
        updateConsole(); saveState();
        return;
      }
      p.score = after;
      if (after === 0){
        setFinished(idx);
      }
    } else if (state.mode === "countup"){
      p.score = before + points;
    } else {
      // Cricket: on garde le fonctionnement existant (pas d'application imm√©diate ici)
    }

    // auto-fin de tour √† 3 fl√©chettes (si pas fini)
    if (state.currentDarts.length === 3 && !state.finished){
      p.turns += 1;
      state.currentDarts = [];
      nextPlayer();
    }

    render();
  }

  function addNumber(n){
    const m = state.mult || 1;
    if (state.mode === "cricket" && n < 15) return;
    const pts = n * m;
    const prefix = m===1?"S":m===2?"D":"T";
    addDart(`${prefix}${n}`, pts, { type:"num", n, mult:m });
  }

  // ‚úÖ Retour = annule la derni√®re fl√©chette (via snapshot)
  function backDart(){
    if (!state || state.finished) return;
    if (state.undoStack.length === 0) return;
    const snap = state.undoStack.shift();
    state.players = snap.players;
    state.current = snap.current;
    state.finished = snap.finished;
    state.history = snap.history;
    state.currentDarts = snap.currentDarts || [];
    state.mult = snap.mult || 1;
    state.cricket = snap.cricket;
    render();
  }

  // Effacer uniquement les fl√©chettes du tour courant (sans toucher aux scores) :
  // on annule autant de fois qu'il y a de fl√©chettes dans currentDarts
  function clearDarts(){
    if (!state || state.finished) return;
    const n = (state.currentDarts || []).length;
    for (let i=0;i<n;i++){
      if (state.undoStack.length === 0) break;
      const snap = state.undoStack.shift();
      state.players = snap.players;
      state.current = snap.current;
      state.finished = snap.finished;
      state.history = snap.history;
      state.currentDarts = snap.currentDarts || [];
      state.mult = snap.mult || 1;
      state.cricket = snap.cricket;
    }
    render();
  }

  function renderScoreboard(){
    mobilePlayersEl.innerHTML = "";
    state.players.forEach((p, idx) => {
      const card = document.createElement("div");
      card.className = "mpCard" + (idx===state.current ? " active" : "");
      const st = p.isWinner ? "WIN" : (state.finished ? "END" : `#${p.turns+1}`);
      card.innerHTML = `
        <div class="mpTop">
          <div class="mpName" title="${escapeHtml(p.name)}">${escapeHtml(p.name)}</div>
          <div>${st}</div>
        </div>
        <div class="mpScore">${p.score}</div>
      `;
      mobilePlayersEl.appendChild(card);
    });
  }

  function renderHistory(){
    historyEl.innerHTML = "";
    if (state.history.length === 0){
      const empty = document.createElement("div");
      empty.className = "hist-item";
      empty.innerHTML = `<span class="muted">Aucun tour pour l‚Äôinstant.</span>`;
      historyEl.appendChild(empty);
      return;
    }
    const items = state.history.slice(0,8);
    items.forEach(h => {
      const tag = h.kind === "bust" ? `<span class="bust">BUST</span>` :
                  h.kind === "win" ? `<span class="win">WIN</span>` : `<span class="muted">OK</span>`;
      const dartsTxt = h.darts?.length ? h.darts.join(" ‚Ä¢ ") : "‚Äî";
      const item = document.createElement("div");
      item.className = "hist-item";
      item.innerHTML = `
        <div style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
          <b>${escapeHtml(h.player)}</b> ‚Äî <b>${escapeHtml(dartsTxt)}</b> ‚Üí <b>${h.input}</b> ${tag}
        </div>
        <div class="muted" style="font-size:11px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
          Avant: ${h.before} ‚Üí Apr√®s: ${h.after}
        </div>
      `;
      historyEl.appendChild(item);
    });
  }

  // --- Cricket helpers (inchang√© / scoring via applyTurn si tu l'utilises encore) ---
  function markToGlyph(m){
    if (m <= 0) return "";
    if (m === 1) return "/";
    if (m === 2) return "X";
    return "‚óâ";
  }
  function isTargetAllClosed(targetKey){
    const marks = state.cricket.marks;
    for (let i=0;i<marks.length;i++){
      if ((marks[i][targetKey] || 0) < 3) return false;
    }
    return true;
  }
  function playerClosedTarget(playerIdx, targetKey){
    return (state.cricket.marks[playerIdx][targetKey] || 0) >= 3;
  }
  function playerClosedAll(playerIdx){
    const m = state.cricket.marks[playerIdx];
    return CRICKET_TARGETS.every(t => (m[String(t)] || 0) >= 3);
  }
  function cricketApplyHit(playerIdx, hit){
    const t = hit.targetKey;
    if (!CRICKET_TARGETS.map(String).includes(t)) return {addedMarks:0, addedPoints:0};

    const marks = state.cricket.marks;
    const allClosed = isTargetAllClosed(t);
    if (allClosed) return {addedMarks:0, addedPoints:0};

    const before = marks[playerIdx][t] || 0;
    const toAdd = hit.marksAdded;

    let newMarks = before + toAdd;
    let overflow = 0;
    if (newMarks > 3){
      overflow = newMarks - 3;
      newMarks = 3;
    }
    marks[playerIdx][t] = newMarks;

    let points = 0;
    const after = marks[playerIdx][t];
    const wasClosedBefore = before >= 3;
    const isClosedNow = after >= 3;

    if (wasClosedBefore){
      points = toAdd * hit.pointsPerExtraMark;
    } else if (isClosedNow && overflow > 0){
      points = overflow * hit.pointsPerExtraMark;
    }

    if (points > 0){
      state.players[playerIdx].score += points;
    }
    return {addedMarks: Math.min(toAdd, 3-before), addedPoints: points};
  }
  function cricketCheckWin(playerIdx){
    if (!playerClosedAll(playerIdx)) return false;
    const myScore = state.players[playerIdx].score;
    const maxOther = Math.max(...state.players.map((p,i)=> i===playerIdx ? -Infinity : p.score));
    return myScore >= maxOther;
  }

  function renderCricketBoard(){
    if (!state || state.mode !== "cricket"){
      cricketHintEl.style.display = "";
      cHeaderRowEl.innerHTML = "";
      cGridEl.innerHTML = "";
      return;
    }
    cricketHintEl.style.display = "none";

    const n = state.players.length;

    cHeaderRowEl.innerHTML = `
      <div class="cHeaderLeft">Cible</div>
      <div class="cHeaderRight" id="cHeaderRight"></div>
    `;
    const right = cHeaderRowEl.querySelector("#cHeaderRight");
    right.style.gridTemplateColumns = `repeat(${n}, minmax(0, 1fr))`;
    state.players.forEach((p) => {
      const c = document.createElement("div");
      c.className = "cHeaderCell";
      c.textContent = p.name;
      c.title = p.name;
      right.appendChild(c);
    });

    cGridEl.innerHTML = "";
    CRICKET_TARGETS.forEach(target => {
      const key = String(target);
      const allClosed = isTargetAllClosed(key);
      const currentIdx = state.current;
      const currentClosed = playerClosedTarget(currentIdx, key);
      const openForCurrent = currentClosed && !allClosed;

      const row = document.createElement("div");
      row.className = "cRow";

      const targetLabel = (target === "B") ? "BULL" : String(target);
      const tag = allClosed ? `<span class="openTag allclosed">ALL</span>` :
                  openForCurrent ? `<span class="openTag open">OPEN</span>` :
                  `<span class="openTag">‚Äî</span>`;

      const left = document.createElement("div");
      left.className = "cTarget";
      left.innerHTML = `<span>${targetLabel}</span>${tag}`;

      const cells = document.createElement("div");
      cells.className = "cCells";
      cells.style.gridTemplateColumns = `repeat(${n}, minmax(0, 1fr))`;

      state.players.forEach((p, idx) => {
        const m = state.cricket.marks[idx][key] || 0;
        const cell = document.createElement("div");
        cell.className = "cCell" + (idx===state.current ? " active" : "") + (m>=3 ? " closed" : "");
        cell.innerHTML = `<span class="marks">${markToGlyph(Math.min(m,3))}</span>`;
        cell.title = `${p.name} : ${m}/3`;
        cells.appendChild(cell);
      });

      row.appendChild(left);
      row.appendChild(cells);
      cGridEl.appendChild(row);
    });
  }

  function buildNumbers(){
    numbersEl.innerHTML = "";
    for (let n=1;n<=20;n++){
      const b = document.createElement("button");
      b.type = "button";
      b.className = "numBtn";
      b.textContent = n;

      if (state && state.mode === "cricket" && n < 15){
        b.dataset.disabled = "1";
        b.disabled = true;
        b.style.opacity = ".35";
      }

      b.addEventListener("click", ()=>addNumber(n));
      numbersEl.appendChild(b);
    }
  }

  function setMobileView(view){
    mobileView = view;

    tabInput.classList.toggle("active", view==="input");
    tabCricket.classList.toggle("active", view==="cricket");
    tabHistory.classList.toggle("active", view==="history");

    panelInput.classList.toggle("active", view==="input");
    panelCricket.classList.toggle("active", view==="cricket");
    panelHistory.classList.toggle("active", view==="history");

    saveState();
  }

  function render(){
    if (!state) return;

    renderScoreboard();

    const p = state.players[state.current];
    turnLabelEl.textContent = state.finished ? "Partie termin√©e" : `üéØ ${p.name}, √† toi !`;

    renderCricketBoard();
    renderHistory();

    setMult(state.mult || 1);
    updateConsole();

    saveState();
  }

  // ‚úÖ Annuler (Undo) : comme avant, restaure snapshot complet (pratique si tu veux remonter plusieurs actions)
  function undo(){
    if (!state || state.undoStack.length === 0) return;
    const snap = state.undoStack.shift();
    state.players = snap.players;
    state.current = snap.current;
    state.finished = snap.finished;
    state.history = snap.history;
    state.currentDarts = snap.currentDarts || [];
    state.mult = snap.mult || 1;
    state.cricket = snap.cricket;
    render();
  }

  function resetGameKeepSetup(){
    const mode = state.mode;
    const startScore = state.startScore;

    state.players = state.players.map(p => ({
      name: p.name,
      score: mode === "x01" ? startScore : 0,
      turns: 0,
      isWinner: false
    }));

    state.current = 0;
    state.finished = false;
    state.history = [];
    state.undoStack = [];
    state.currentDarts = [];
    state.mult = 1;

    if (mode === "cricket"){
      state.cricket = { marks: createCricketMarks(state.players.length) };
    } else {
      delete state.cricket;
    }

    render();
  }

  // Setup events
  numPlayersEl.addEventListener("change", renderNameInputs);
  modeEl.addEventListener("change", () => {
    startScoreEl.disabled = (modeEl.value !== "x01");
  });

  startBtn.addEventListener("click", () => {
    state = createGameFromSetup();
    showGame();
    buildNumbers();
    mobileView = "input";
    setMobileView("input");
    render();
  });

  loadBtn.addEventListener("click", () => {
    const loaded = loadState();
    if (!loaded) { alert("Aucune partie sauvegard√©e trouv√©e."); return; }
    state = loaded;

    if (state.mode === "cricket" && (!state.cricket || !state.cricket.marks)){
      state.cricket = { marks: createCricketMarks(state.players.length) };
    }
    showGame();
    buildNumbers();
    setMobileView(mobileView || "input");
    render();
  });

  // Game events
  mS.addEventListener("click", ()=>setMult(1));
  mD.addEventListener("click", ()=>setMult(2));
  mT.addEventListener("click", ()=>setMult(3));

  missBtn.addEventListener("click", ()=>addDart("MISS", 0, {type:"miss"}));
  sbBtn.addEventListener("click", ()=>addDart("SB", 25, {type:"bull", marks:1}));
  dbBtn.addEventListener("click", ()=>addDart("DB", 50, {type:"bull", marks:2}));

  backBtn.addEventListener("click", backDart);
  clearBtn.addEventListener("click", clearDarts);

  // applyBtn inutilis√© mais on le laisse sans action
  if (applyBtn) applyBtn.addEventListener("click", (e) => e.preventDefault());

  undoBtn.addEventListener("click", undo);

  resetBtn.addEventListener("click", () => {
    if (!confirm("R√©initialiser la partie ?")) return;
    resetGameKeepSetup();
  });

  newGameBtn.addEventListener("click", () => {
    if (!confirm("Revenir √† l'√©cran de configuration ?")) return;
    state = null;
    showSetup();
  });

  // Tabs
  tabInput.addEventListener("click", ()=>setMobileView("input"));
  tabCricket.addEventListener("click", ()=>setMobileView("cricket"));
  tabHistory.addEventListener("click", ()=>setMobileView("history"));

  // Keyboard shortcuts
  window.addEventListener("keydown", (e) => {
    if (!state || setupEl.style.display !== "none") return;
    if (e.key === "Backspace") { e.preventDefault(); backDart(); }
    if (e.key === "Escape") { e.preventDefault(); clearDarts(); }
    // Enter ne sert plus
  });

  // Init
  renderNameInputs();
  startScoreEl.disabled = (modeEl.value !== "x01");
  showSetup();
})();
</script>

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js");
  }
</script>

</body>
</html>
