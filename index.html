<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>CLEMEX Fl√©chettes ‚Äì Scoreboard</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#F2E9DC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="icon" type="image/png" href="icon-192.png">

  <style>
    /* ==========================================================
       CLEMEX Fl√©chettes ‚Äì Redesign (logo-matching UI)
       Beige/cr√®me + encre noire + accent rouge savoyard
       ========================================================== */

    :root{
  /* Palette (beige majoritaire + noir + rouge l√©ger) */
  --ok: #1D7A4A;
  --warn: #C42B2B;
  --bg0:#F6EFE4;
  --bg1:#EFE4D4;

  --surface: rgba(255,255,255,.62);   /* cartes */
  --surface2: rgba(255,255,255,.42);  /* sous-cartes */
  --surface3: rgba(255,255,255,.30);  /* √©l√©ments (chips/tabs) */

  --ink:#171513;
  --ink2: rgba(23,21,19,.72);
  --ink3: rgba(23,21,19,.50);

  --line: rgba(23,21,19,.10);
  --line2: rgba(23,21,19,.14);

  --accent:#C42B2B;
  --accentDeep:#9A1F1F;
  --accentSoft: rgba(196,43,43,.12);

  /* Style ‚Äúdashboard‚Äù */
  --r20:20px;
  --r16:16px;
  --r12:12px;

  --shadow: 0 14px 34px rgba(23,21,19,.10);
  --shadow2: 0 8px 18px rgba(23,21,19,.08);

  --blur: blur(12px);
  --r18:18px;

  /* typo un peu plus ‚Äúmoderne / app‚Äù */
  --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

    *{ box-sizing:border-box; }
    html, body{ height:100%; }

    body{
  margin:0;
  font-family: var(--font);
  color: var(--ink);

  /* Fond plus ‚Äúflat dashboard‚Äù */
  background:
    radial-gradient(900px 700px at 15% 0%, rgba(196,43,43,.08), transparent 60%),
    radial-gradient(900px 700px at 85% 10%, rgba(23,21,19,.06), transparent 60%),
    linear-gradient(180deg, var(--bg0), var(--bg1));

  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
}

    .wrap{
      position: relative;
      z-index: 1;
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }

    /* ----------------------------------------------------------
       Top bar (header)
       ---------------------------------------------------------- */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 5;
      padding-top: env(safe-area-inset-top);
    
      margin: -16px -16px 14px;
      padding: 12px 16px;
    
      /* Barre nette (style dashboard) */
      background: rgba(246,239,228,.92);
      border-bottom: 1px solid rgba(23,21,19,.08);
    
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
    }

    .brandRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }

    .brand img{
      width: 28px;
      height: 28px;
      border-radius: 9px;
      box-shadow: 0 10px 20px rgba(23,21,19,.14);
      flex: 0 0 auto;
    }

    .brand h1{
      margin:0;
      font-size: 16px;
      font-weight: 950;
      letter-spacing:.2px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      padding: 8px 12px;
      border-radius: 999px;
    
      background: rgba(255,255,255,.70);
      border: 1px solid rgba(23,21,19,.10);
      box-shadow: var(--shadow2);
    
      font-size: 12px;
      color: var(--ink2);
      white-space: nowrap;
    }

    /* ----------------------------------------------------------
       Surfaces / cards / text
       ---------------------------------------------------------- */
    .card{
      border-radius: var(--r20);
      border: 1px solid rgba(23,21,19,.10);
      background: var(--surface);
      box-shadow: var(--shadow);
    
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
    
      padding: 14px;
    }
    
    .subcard{
      border-radius: var(--r16);
      border: 1px solid rgba(23,21,19,.10);
      background: var(--surface2);
      box-shadow: var(--shadow2);
      padding: 12px;
    }

    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .col{ flex: 1 1 320px; min-width: 280px; }

    .muted{ color: var(--ink3); font-size: 12px; }
    .hr{ height:1px; background: rgba(23,21,19,.10); margin: 12px 0; }

    label{
      display:block;
      font-size: 12px;
      color: var(--ink2);
      margin: 10px 0 6px;
      font-weight: 800;
      letter-spacing: .2px;
    }

    /* ----------------------------------------------------------
       Inputs
       ---------------------------------------------------------- */
    select,input,button{
      font-family: var(--font);
    }

    select, input{
      width:100%;
      padding: 12px 12px;
      border-radius: var(--r16);
      border:1px solid rgba(23,21,19,.14);
      background: rgba(255,255,255,.55);
      color: var(--ink);
      outline:none;
      box-shadow: 0 6px 16px rgba(23,21,19,.06);
    }

    select:focus, input:focus{
      border-color: rgba(196,43,43,.35);
      box-shadow: 0 0 0 4px rgba(196,43,43,.14), 0 10px 22px rgba(23,21,19,.08);
    }

    input::placeholder{ color: rgba(23,21,19,.35); }

    /* ----------------------------------------------------------
       Buttons
       ---------------------------------------------------------- */
    .actionsRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .actionsRow > *{ flex: 1 1 180px; }

    button{
      width:100%;
      padding: 12px 12px;
      border-radius: var(--r16);
      border: 1px solid rgba(23,21,19,.10);
    
      cursor:pointer;
      font-weight: 950;
      letter-spacing: .2px;
    
      transition: transform .06s ease, filter .15s ease, box-shadow .15s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    
      background: rgba(255,255,255,.70);
      box-shadow: var(--shadow2);
    }
    
    button:active{ transform: translateY(1px); }
    
    button.primary{
      color: #fff;
      border: 1px solid rgba(0,0,0,0);
      background: linear-gradient(180deg, var(--accent), var(--accentDeep));
      box-shadow: 0 14px 26px rgba(196,43,43,.18);
    }

    button.primary:hover{ filter: brightness(1.03); }

    button.secondary{
      color: var(--ink);
      background: rgba(255,255,255,.78);
    }

    button.danger{
      color:#fff;
      background: linear-gradient(180deg, #C42B2B, #8D1919);
      box-shadow: 0 14px 26px rgba(196,43,43,.22);
    }

    button:disabled{
      opacity: .55;
      cursor: not-allowed;
      box-shadow:none;
      transform:none;
    }

    /* ----------------------------------------------------------
       Desktop scoreboard
       ---------------------------------------------------------- */
    .scoreboard{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .player{
      border-radius: var(--r18);
      border: 1px solid rgba(23,21,19,.10);
      background: rgba(255,255,255,.42);
      box-shadow: var(--shadow2);
      padding: 12px;
      position: relative;
      overflow:hidden;
    }

    .player.active{
      border-color: rgba(196,43,43,.28);
      outline: 2px solid rgba(196,43,43,.16);
      background: linear-gradient(180deg, rgba(196,43,43,.10), rgba(255,255,255,.42));
    }

    .phead{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .phead b{ font-size: 14px; font-weight: 950; }

    .status{ font-size: 12px; color: var(--ink3); }
    .big{ font-size: 40px; font-weight: 990; margin: 10px 0 2px; }
    .small{ font-size: 12px; color: var(--ink3); }

    .win{ color: var(--ok); font-weight: 990; }
    .bust{ color: var(--warn); font-weight: 990; }

    /* ----------------------------------------------------------
       Turn banner
       ---------------------------------------------------------- */
    .turnBanner{
      margin-top: 10px;
      padding: 12px;
      border-radius: var(--r18);
      border: 1px solid rgba(23,21,19,.10);
      background: rgba(255,255,255,.42);
      box-shadow: var(--shadow2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .turnBanner b{ font-size: 14px; font-weight: 950; }
    .kbd{
      font-size: 11px;
      color: var(--ink3);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .kbd span{
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid rgba(23,21,19,.10);
      background: rgba(255,255,255,.45);
    }

    /* ----------------------------------------------------------
       Console
       ---------------------------------------------------------- */
    .grid2{ display:grid; grid-template-columns: 1.12fr .88fr; gap: 12px; }
    @media (max-width: 860px){ .grid2{ grid-template-columns: 1fr; } }

    .console{
      border-radius: var(--r18);
      border:1px solid rgba(23,21,19,.10);
      background: rgba(255,255,255,.40);
      box-shadow: var(--shadow2);
      padding: 12px;
    }

    .readout{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top: 8px;
    }

    .chips{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .chip{
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(23,21,19,.10);
      background: rgba(255,255,255,.45);
      font-size: 12px;
      color: var(--ink2);
      font-weight: 850;
    }
    .chip b{ color: var(--ink); font-weight: 990; }

    .chips button{
      width:auto;
      padding: 10px 12px;
      border-radius: 999px;
    }

    .dartsRow{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    .dartSlot{
      border-radius: 16px;
      border:1px solid rgba(23,21,19,.10);
      background: rgba(255,255,255,.45);
      padding: 12px;
      min-height: 70px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      box-shadow: 0 10px 18px rgba(23,21,19,.08);
    }
    .dartSlot .label{ font-size: 14px; font-weight: 950; }
    .dartSlot .pts{ font-size: 18px; font-weight: 990; }
    .dartSlot.empty{ opacity:.55; box-shadow:none; }

    .totalBox{
      border-radius: 16px;
      border:1px solid rgba(196,43,43,.22);
      background: rgba(196,43,43,.10);
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top: 10px;
      box-shadow: 0 14px 24px rgba(196,43,43,.10);
    }
    .totalBox b{ font-size: 14px; font-weight: 950; }
    .totalBox .total{ font-size: 28px; font-weight: 999; }

    .selector{
      margin-top: 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    /* Segmented control ‚Äì clean */
    .toggles{
      display:flex;
      gap:6px;
      background: rgba(255,255,255,.45);
      border:1px solid rgba(23,21,19,.10);
      border-radius: 999px;
      padding: 6px;
      box-shadow: 0 10px 18px rgba(23,21,19,.08);
    }

    .toggles button{
      width:auto;
      padding: 10px 14px;
      border-radius: 999px;
      background: transparent;
      border:1px solid transparent;
      box-shadow:none;
      font-weight: 990;
      color: var(--ink3);
    }
    .toggles button.active{
      background: rgba(196,43,43,.14);
      border-color: rgba(196,43,43,.18);
      color: var(--ink);
    }

    .quickRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 10px; }

    .miniBtn{
      width:auto;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.45);
      border:1px solid rgba(23,21,19,.10);
      box-shadow: 0 10px 18px rgba(23,21,19,.08);
      font-weight: 990;
      color: var(--ink);
    }

    .numbers{
      margin-top: 10px;
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 8px;
    }
    .numBtn{
      padding: 14px 0;
      border-radius: 18px;
      background: rgba(255,255,255,.48);
      border:1px solid rgba(23,21,19,.10);
      box-shadow: 0 10px 18px rgba(23,21,19,.08);
      font-size: 15px;
      font-weight: 999;
      color: var(--ink);
    }

    /* Right side */
    #rightDesktop.card{ background: rgba(255,255,255,.34); }

    /* History */
    .history{
      max-height: 360px;
      overflow:auto;
      border-radius: var(--r18);
      border:1px solid rgba(23,21,19,.10);
      background: rgba(255,255,255,.40);
      box-shadow: 0 10px 18px rgba(23,21,19,.08);
    }
    .hist-item{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(23,21,19,.08);
      font-size: 13px;
    }
    .hist-item:last-child{ border-bottom:none; }

    /* Cricket */
    .cricketWrap{ margin-top: 12px; }
    .cricketTitle{ display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center; }

    .cricketLegend{ display:flex; gap:8px; flex-wrap:wrap; }
    .cricketLegend .chip{ font-size: 11px; }

    .cricketGrid{
      margin-top: 10px;
      border-radius: var(--r18);
      border:1px solid rgba(23,21,19,.10);
      overflow:hidden;
      background: rgba(255,255,255,.40);
      box-shadow: 0 10px 18px rgba(23,21,19,.08);
    }

    .cRow{
      display:grid;
      grid-template-columns: 90px 1fr;
      border-bottom:1px solid rgba(23,21,19,.08);
      background: rgba(255,255,255,.22);
    }
    .cRow:last-child{ border-bottom:none; }

    .cTarget{
      padding: 10px 12px;
      font-weight: 990;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-right:1px solid rgba(23,21,19,.08);
      background: rgba(255,255,255,.36);
    }

    .cCells{ display:grid; }
    .cCell{
      padding: 10px 10px;
      border-right:1px solid rgba(23,21,19,.08);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 990;
      color: var(--ink3);
      background: rgba(255,255,255,.18);
    }
    .cCell:last-child{ border-right:none; }
    .cCell.active{ background: rgba(196,43,43,.10); color: var(--ink); }
    .cCell.closed{ color: var(--ok); }
    .cCell .marks{ letter-spacing: 1px; font-size: 14px; }

    .openTag{
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid rgba(23,21,19,.10);
      background: rgba(255,255,255,.48);
      color: var(--ink2);
      font-weight: 990;
    }
    .openTag.allclosed{
      border-color: rgba(29,122,74,.22);
      background: rgba(29,122,74,.10);
      color: var(--ok);
    }
    .openTag.open{
      border-color: rgba(196,43,43,.22);
      background: rgba(196,43,43,.12);
      color: var(--ink);
    }

    .cHeaderRow{
      display:grid;
      grid-template-columns: 90px 1fr;
      border-radius: var(--r18);
      overflow:hidden;
      border:1px solid rgba(23,21,19,.10);
      margin-top: 10px;
      background: rgba(255,255,255,.30);
      box-shadow: 0 10px 18px rgba(23,21,19,.08);
    }
    .cHeaderLeft{
      padding: 10px 12px;
      font-size: 12px;
      color: var(--ink2);
      border-right:1px solid rgba(23,21,19,.08);
      background: rgba(255,255,255,.40);
      font-weight: 990;
    }
    .cHeaderRight{ display:grid; }
    .cHeaderCell{
      padding: 10px 10px;
      font-size: 12px;
      color: var(--ink2);
      font-weight: 990;
      text-align:center;
      border-right:1px solid rgba(23,21,19,.08);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .cHeaderCell:last-child{ border-right:none; }

    /* ----------------------------------------------------------
       Mobile ‚Äì NO vertical scroll (like your original)
       Modern spacing + better ergonomics
       ---------------------------------------------------------- */

    /* Mobile-only elements hidden on desktop */
    .mobilePlayers, .tabs, .mobilePanels { display:none; }

    @media (max-width: 640px){
      html, body { height: 100%; }
      body{
        overflow: hidden;
        height: 100dvh;
        padding-top: 0;
        padding-bottom: 0;
      }

      /* Watermark a bit bigger on mobile */
      body::before{
        background-position: center 38vh;
        background-size: min(400px, 92vw);
        opacity: .20;
      }

      .wrap{
        max-width: 100%;
        height: 100dvh;
        padding: 10px;
        display:flex;
        flex-direction: column;
      }

      .topbar{
        position: sticky;
        top:0;
        margin: -10px -10px 10px;
        padding: 10px 10px 8px;
      }

      .brand img{ width: 26px; height: 26px; border-radius: 8px; }
      .brand h1{ font-size: 15px; }

      /* Setup card pushed down so logo is visible */
      #setup{
        margin-top: 18vh;
      }
      #setup.card{
        background: rgba(255,255,255,.46);
      }

      /* Game takes full height */
      #game{
        margin-top: 10px !important;
        flex: 1;
        min-height: 0;
        display:flex;
        flex-direction: column;
        overflow:hidden;
        padding-bottom: env(safe-area-inset-bottom);
      }

      /* Hide desktop grid on mobile */
      .grid2{ display:none !important; }
      .scoreboard{ display:none !important; }

      /* Player strip */
      .mobilePlayers{
        display:flex;
        gap:8px;
        overflow-x:auto;
        overflow-y:hidden;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 6px;
        margin-top: 8px;
      }
      .mpCard{
        min-width: 118px;
        padding: 9px 10px;
        border-radius: 16px;
        border:1px solid rgba(23,21,19,.10);
        background: rgba(255,255,255,.46);
        box-shadow: 0 10px 18px rgba(23,21,19,.10);
      }
      .mpCard.active{
        border-color: rgba(196,43,43,.26);
        background: rgba(196,43,43,.10);
      }
      .mpTop{
        font-size: 10px;
        color: var(--ink3);
        display:flex;
        justify-content:space-between;
        gap:8px;
      }
      .mpName{
        font-size: 12px;
        max-width: 84px;
        color: var(--ink);
        font-weight: 990;
        overflow:hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .mpScore{
        font-size: 18px;
        margin-top: 4px;
        font-weight: 999;
      }

      /* Turn banner compact */
      .turnBanner{ display:none !important; }

      /* Tabs ‚Äì nicer segmented control */
      .tabs{
      display:flex;
      gap:6px;
      margin-top: 8px;
      padding: 6px;
    
      border-radius: 999px;
      border: 1px solid rgba(23,21,19,.10);
      background: rgba(255,255,255,.60);
      box-shadow: var(--shadow2);
    }
    
    .tabs button{
      width: 100%;
      padding: 10px 8px;
      font-size: 13px;
    
      border-radius: 999px;
      background: transparent;
      border: 1px solid transparent;
      color: var(--ink3);
      box-shadow:none;
    }
    
    .tabs button.active{
      background: rgba(255,255,255,.85);
      border-color: rgba(23,21,19,.10);
      color: var(--ink);
    }

      /* Panels (no vertical scroll) */
      .mobilePanels{
        display:flex;
        flex-direction: column;
        flex: 1;
        min-height: 0;
        overflow:hidden;
        margin-top: 8px;
      }
      .panel{ display:none; flex: 1; min-height: 0; overflow:hidden; }
      .panel.active{ display:block; }

      /* Console fits */
      .console{
        padding: 10px;
        height: 100%;
        display:flex;
        flex-direction: column;
        min-height: 0;
        overflow:hidden;
        background: rgba(255,255,255,.44);
      }

      .readout{ margin-top: 0; gap:6px; }
      .chip{ padding: 6px 9px; font-size: 11px; }

      .chips button{
        padding: 9px 10px;
        font-size: 12px;
      }

      .dartsRow{ margin-top: 8px; gap:8px; }
      .dartSlot{ min-height: 52px; padding: 10px; border-radius: 16px; }
      .dartSlot .label{ font-size: 12px; }
      .dartSlot .pts{ font-size: 14px; }

      .totalBox{ margin-top: 8px; padding: 10px 12px; border-radius: 16px; }
      .totalBox b{ font-size: 13px; }
      .totalBox .total{ font-size: 22px; }

      .selector{ margin-top: 8px; }
      .toggles{ padding: 4px; gap:6px; }
      .toggles button{ padding: 8px 10px; font-size: 13px; }

      #hint{ font-size: 11px; color: var(--ink3); }

      .quickRow{ margin-top: 8px; gap:8px; }
      .miniBtn{ padding: 10px 12px; font-size: 13px; border-radius: 16px; }

      /* Keypad takes remaining height */
      .numbers{
          margin-top: 6px;
          flex: 1;
          min-height: 0;
          display: grid;
          grid-template-columns: repeat(5, minmax(0, 1fr));
          gap: 8px;
          grid-auto-rows: 1fr; /* ‚úÖ ici */
        }
        
        .numbers .numBtn{
          height: 100%;
          border-radius: 18px;
          font-size: 20px;
          font-weight: 999;
          background: rgba(255,255,255,.82);
          border: 1px solid rgba(23,21,19,.10);
          box-shadow: var(--shadow2);
        }

      .actionsRow{ margin-top: 8px; gap:8px; }
      #applyBtn{ padding: 12px 12px; font-size: 15px; border-radius: 18px; }

      #rulesNote{ display:none !important; }

      /* Cricket + history panels: no scroll */
      .history{ height: 100%; overflow:hidden; max-height: none; }
      .cricketLegend{ display:none; }
      .cricketTitle{ display:none !important; }     /* enl√®ve ‚ÄúCible Cricket‚Äù */
      .cHeaderRow{ margin-top: 6px !important; }
      .cricketGrid{ margin-top: 6px !important; }
      .cRow{ grid-template-columns: 60px 1fr; }
      .cTarget{ padding: 6px 6px; font-size: 11px; }
      .cCell{ padding: 6px 4px; }
      .cHeaderLeft{ padding: 6px 6px; font-size: 10px; }
      .cHeaderCell{ padding: 6px 4px; font-size: 10px; }
      .cCell .marks{ font-size: 13px !important; letter-spacing: .5px !important; }

      /* Mobile-only visible */
      .mobilePlayers, .tabs, .mobilePanels { display:flex; }
      
  /* 1) On r√©cup√®re de la hauteur partout */
  .topbar{ margin: -10px -10px 6px !important; padding: 8px 10px 6px !important; }
  .brand h1{ font-size: 14px !important; }
  .pill{ padding: 6px 10px !important; font-size: 11px !important; }

  /* Carte globale un peu moins ‚Äúgrosse‚Äù */
  .card{ padding: 10px !important; border-radius: 18px !important; }

  /* Zone game plus compacte */
  #game{ margin-top: 8px !important; }

  /* Bandeau joueurs (strip) + cartes plus compactes */
  .mobilePlayers{ margin-top: 6px !important; padding-bottom: 4px !important; }
  .mpCard{ min-width: 104px !important; padding: 6px 8px !important; border-radius: 14px !important; }
  .mpTop{ font-size: 10px !important; }
  .mpName{ font-size: 12px !important; }
  .mpScore{ font-size: 18px !important; }

  /* Turn banner plus fin */
  .turnBanner{ margin-top: 6px !important; padding: 7px 9px !important; }
  .turnBanner b{ font-size: 12px !important; }

  /* Tabs plus fines */
  .tabs{ margin-top: 6px !important; padding: 4px !important; gap: 6px !important; }
  .tabs button{ padding: 7px 8px !important; font-size: 12px !important; }

  /* Console compacte */
  .console{ padding: 8px !important; }
  .readout{ gap: 6px !important; }

  /* Chips plus petits */
  .chip{ padding: 4px 7px !important; font-size: 10px !important; }

  /* Boutons secondaires (Annuler/Retour/Effacer) : compacts */
  #undoBtn, #backBtn, #clearBtn{
    padding: 8px 10px !important;
    font-size: 12px !important;
    border-radius: 12px !important;
  }

  /* Slots fl√©chettes : plus petits */
  .dartsRow{ margin-top: 6px !important; gap: 6px !important; }
  .dartSlot{ min-height: 40px !important; padding: 7px !important; border-radius: 12px !important; }
  .dartSlot .label{ font-size: 11px !important; }
  .dartSlot .pts{ font-size: 13px !important; }

  /* Total : plus fin */
  .totalBox{ margin-top: 6px !important; padding: 8px 10px !important; border-radius: 14px !important; }
  .totalBox b{ font-size: 12px !important; }
  .totalBox .total{ font-size: 20px !important; }

  /* Multiplicateurs : encore plus compact */
  .selector{ margin-top: 6px !important; }
  .toggles{ padding: 4px !important; gap: 5px !important; }
  .toggles button{ padding: 6px 8px !important; font-size: 12px !important; }

  /* Boutons rapides : compacts */
  .quickRow{ margin-top: 6px !important; gap: 6px !important; }
  .miniBtn{ padding: 8px 10px !important; font-size: 13px !important; border-radius: 12px !important; }

  /* Astuce ergonomie : sensation de ‚Äúclavier‚Äù */
  .numbers .numBtn:active{
    transform: translateY(1px);
    filter: brightness(0.98);
  }

  /* 3) Bouton valider : compact mais toujours tr√®s visible */
  #applyBtn{
    padding: 12px 12px !important;
    font-size: 15px !important;
    border-radius: 16px !important;
  }

  /* =========================
     CRICKET : faire rentrer la grille
     ========================= */
  /* On enl√®ve de l‚Äôair au-dessus */
  #panelCricket .cricketWrap{ margin-top: 6px !important; }

  /* En-t√™te + cellules plus compactes */
  .cHeaderLeft{ padding: 6px 7px !important; font-size: 10px !important; }
  .cHeaderCell{ padding: 6px 5px !important; font-size: 10px !important; }

  /* Ligne : plus basse */
  .cRow{ grid-template-columns: 60px 1fr !important; }
  .cTarget{ padding: 6px 6px !important; font-size: 11px !important; }
  .cCell{ padding: 6px 4px !important; }

  /* Marques un poil plus compactes */
  .cCell .marks{ font-size: 13px !important; letter-spacing: .5px !important; }

  /* Cache le titre ‚ÄúCible Cricket‚Äù si tu veux gagner encore plus */
  /* D√©commente si n√©cessaire */
  /*
  .cricketTitle{ display:none !important; }
  */
    }
  /* =========================
   SETUP PAGE ‚Äì Modern redesign
   ========================= */

/* Fond plus clean (sans watermark) */
body{
  background:
    radial-gradient(900px 700px at 15% 0%, rgba(196,43,43,.06), transparent 60%),
    radial-gradient(900px 700px at 85% 10%, rgba(23,21,19,.05), transparent 60%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
}

/* Carte setup = plus premium */
#setup.card{
  background: rgba(255,255,255,.72);
  border: 1px solid rgba(23,21,19,.10);
  box-shadow: 0 22px 60px rgba(23,21,19,.12);
  padding: 18px;
}

/* Sections + respiration */
#setup .row{ gap: 16px; }
#setup .hr{ margin: 14px 0; opacity: .9; }

/* Labels plus ‚Äúapp‚Äù */
#setup label{
  font-size: 12px;
  color: rgba(23,21,19,.70);
  font-weight: 900;
  letter-spacing: .3px;
  margin: 12px 0 6px;
}

/* Inputs / selects plus modernes */
#setup select,
#setup input{
  border-radius: 18px;
  border: 1px solid rgba(23,21,19,.10);
  background: rgba(255,255,255,.85);
  padding: 14px 14px;
  box-shadow: 0 10px 24px rgba(23,21,19,.06);
}

#setup select:focus,
#setup input:focus{
  border-color: rgba(196,43,43,.35);
  box-shadow: 0 0 0 4px rgba(196,43,43,.12), 0 14px 30px rgba(23,21,19,.10);
}

/* Texte d‚Äôaide plus discret */
#setup .muted{
  font-size: 12px;
  color: rgba(23,21,19,.55);
  line-height: 1.35;
}

/* Zone noms joueurs = stack clean */
#names input{ margin-bottom: 10px !important; }

/* Boutons setup = style premium + ergonomique */
#setup .actionsRow{
  gap: 12px;
}

#startBtn{
  border-radius: 20px;
  padding: 14px 14px;
  font-size: 15px;
  box-shadow: 0 18px 34px rgba(196,43,43,.22);
}

#loadBtn{
  border-radius: 20px;
  padding: 14px 14px;
  font-size: 15px;
  background: rgba(255,255,255,.92);
}

/* Mobile : la carte doit √™tre plus ‚Äúcentr√©e‚Äù et plus compacte */
@media (max-width: 640px){
  #setup{ margin-top: 14vh; } /* ajuste 10‚Äì18vh selon ton go√ªt */
  #setup.card{
    padding: 14px;
    border-radius: 22px;
  }

  /* Les 2 boutons en colonne (plus moderne) */
  #setup .actionsRow{
    flex-direction: column;
  }
  #setup .actionsRow > *{
    flex: 1 1 auto;
  }
}

  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brandRow">
        <div class="brand">
          <img src="icon-192.png" alt="CLEMEX">
          <h1>Fl√©chettes ‚Äì Scoreboard</h1>
        </div>
        <div class="pill" id="topBadge">Pr√™t</div>
      </div>
    </div>

    <!-- SETUP -->
    <div id="setup" class="card">
      <div class="row">
        <div class="col">
          <label>Mode de jeu</label>
          <select id="mode">
            <option value="x01">X01 (301 / 501 / 701) ‚Äì bust</option>
            <option value="countup">Count Up ‚Äì addition</option>
            <option value="cricket">Cricket (20‚Üí15 + Bull)</option>
          </select>

          <label>Score de d√©part (X01)</label>
          <select id="startScore">
            <option value="301">301</option>
            <option value="501" selected>501</option>
            <option value="701">701</option>
          </select>

          <label>Nombre de joueurs</label>
          <select id="numPlayers">
            <option value="1">1</option>
            <option value="2" selected>2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
          </select>

          <div class="muted" style="margin-top:10px">
            S / D / T + num√©ro. En <b>Cricket</b>, seuls 15‚Äì20 + Bull comptent.
          </div>
        </div>

        <div class="col">
          <label>Noms des joueurs</label>
          <div id="names"></div>
          <div class="muted" style="margin-top:10px">Vide = ‚ÄúJoueur 1‚Äù, etc.</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="actionsRow">
        <button id="startBtn" class="primary">D√©marrer</button>
        <button id="loadBtn" class="secondary">Reprendre la derni√®re partie</button>
      </div>
    </div>

    <!-- GAME -->
    <div id="game" class="card" style="display:none; margin-top: 14px;">
      <div class="row" style="align-items:center; justify-content:space-between;">
        <div class="pill" id="modeBadge">Mode</div>
        <div class="actionsRow" style="max-width:420px;">
          <button id="newGameBtn" class="secondary">Nouvelle partie</button>
          <button id="resetBtn" class="danger">R√©initialiser</button>
        </div>
      </div>

      <!-- Desktop scoreboard -->
      <div class="scoreboard" id="scoreboard"></div>

      <!-- Mobile compact scoreboard -->
      <div class="mobilePlayers" id="mobilePlayers"></div>

      <div class="turnBanner">
        <b id="turnLabel">‚Äî</b>
        <div class="kbd">
          <span>Entr√©e = Valider</span>
          <span>Backspace = Retour</span>
          <span>Esc = Effacer</span>
        </div>
      </div>

      <!-- Mobile tabs -->
      <div class="tabs" id="tabs" role="tablist" aria-label="Vue mobile">
        <button type="button" id="tabInput" class="active">Saisie</button>
        <button type="button" id="tabCricket">Cricket</button>
        <button type="button" id="tabHistory">Historique</button>
      </div>

      <!-- Mobile panels -->
      <div class="mobilePanels" id="mobilePanels">
        <div class="panel active" id="panelInput"></div>
        <div class="panel" id="panelCricket"></div>
        <div class="panel" id="panelHistory"></div>
      </div>

      <!-- Desktop layout below -->
      <div class="grid2" id="desktopGrid">
        <!-- CONSOLE -->
        <div class="console" id="consoleDesktop">
          <div class="readout">
            <div class="chips">
              <span class="chip">Fl√©chettes : <b id="dartsCount">0</b>/3</span>
              <span class="chip">Mode tir : <b id="multLabel">S</b></span>
            </div>
            <div class="chips">
              <button id="undoBtn" class="secondary" style="width:auto">Annuler tour</button>
              <button id="backBtn" class="secondary" style="width:auto">‚Üê Retour</button>
              <button id="clearBtn" class="secondary" style="width:auto">Effacer</button>
            </div>
          </div>

          <div class="dartsRow" id="dartsRow"></div>

          <div class="totalBox">
            <b>Total du tour</b>
            <div class="total" id="turnTotal">0</div>
          </div>

          <div class="selector">
            <div class="toggles" role="tablist" aria-label="Multiplicateur">
              <button id="mS" class="active" type="button">S</button>
              <button id="mD" type="button">D</button>
              <button id="mT" type="button">T</button>
            </div>
            <div class="muted" id="hint">S = simple (x1)</div>
          </div>

          <div class="quickRow">
            <button class="miniBtn" id="missBtn" type="button">MISS (0)</button>
            <button class="miniBtn" id="sbBtn" type="button">SB (25)</button>
            <button class="miniBtn" id="dbBtn" type="button">DB (50)</button>
          </div>

          <div class="numbers" id="numbers"></div>

          <div class="actionsRow">
            <button id="applyBtn" class="primary">Valider le tour</button>
          </div>

          <div class="muted" style="margin-top:10px" id="rulesNote">
            X01 : si le total fait passer sous 0 ‚Üí <b>bust</b>. Tu peux valider avec 1, 2 ou 3 fl√©chettes.
          </div>
        </div>

        <!-- RIGHT: cricket + history -->
        <div class="card" id="rightDesktop" style="padding:14px;">
          <div id="cricketBoard" class="cricketWrap" style="display:none;">
            <div class="cricketTitle">
              <b>üéØ Cible Cricket</b>
              <div class="cricketLegend">
                <span class="chip">Marques : <b>/</b> = 1, <b>X</b> = 2, <b>‚óâ</b> = 3</span>
                <span class="chip">Open = le joueur actif peut scorer</span>
              </div>
            </div>

            <div class="cHeaderRow" id="cHeaderRow"></div>
            <div class="cricketGrid" id="cGrid"></div>
            <div class="hr"></div>
          </div>

          <b>Historique</b>
          <div class="muted" style="margin:6px 0 10px">Derniers tours en haut</div>
          <div class="history" id="history"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const $ = (id) => document.getElementById(id);

      const setupEl = $("setup");
      const gameEl = $("game");

      const topBadge = $("topBadge");
      const modeBadge = $("modeBadge");

      const modeEl = $("mode");
      const startScoreEl = $("startScore");
      const numPlayersEl = $("numPlayers");
      const namesWrap = $("names");

      const startBtn = $("startBtn");
      const loadBtn = $("loadBtn");

      const scoreboardEl = $("scoreboard");
      const mobilePlayersEl = $("mobilePlayers");

      const historyEl = $("history");
      const turnLabelEl = $("turnLabel");
      const cricketBoardEl = $("cricketBoard");
      const cHeaderRowEl = $("cHeaderRow");
      const cGridEl = $("cGrid");
      const rulesNoteEl = $("rulesNote");

      const applyBtn = $("applyBtn");
      const undoBtn = $("undoBtn");
      const resetBtn = $("resetBtn");
      const newGameBtn = $("newGameBtn");

      // Dart console
      const dartsCountEl = $("dartsCount");
      const dartsRowEl = $("dartsRow");
      const turnTotalEl = $("turnTotal");
      const backBtn = $("backBtn");
      const clearBtn = $("clearBtn");

      // Mult toggles
      const mS = $("mS"), mD = $("mD"), mT = $("mT");
      const multLabelEl = $("multLabel");
      const hintEl = $("hint");

      // quick
      const missBtn = $("missBtn"), sbBtn = $("sbBtn"), dbBtn = $("dbBtn");
      const numbersEl = $("numbers");

      // Mobile tabs/panels
      const tabInput = $("tabInput");
      const tabCricket = $("tabCricket");
      const tabHistory = $("tabHistory");
      const panelInput = $("panelInput");
      const panelCricket = $("panelCricket");
      const panelHistory = $("panelHistory");

      const consoleDesktop = $("consoleDesktop");
      const rightDesktop = $("rightDesktop");
      const cricketBoardDesktop = $("cricketBoard");

      const STORAGE_KEY = "flechettes_app_state_clemex_redesign_v1";
      const CRICKET_TARGETS = [20,19,18,17,16,15,"B"];
      const BULL_POINTS_PER_MARK = 25;

      let state = null;
      let mobileView = "input"; // input | cricket | history

      function isMobile(){
        return window.matchMedia && window.matchMedia("(max-width: 640px)").matches;
      }

      function renderNameInputs() {
        const n = Number(numPlayersEl.value);
        namesWrap.innerHTML = "";
        for (let i=0;i<n;i++) {
          const inp = document.createElement("input");
          inp.type = "text";
          inp.placeholder = `Joueur ${i+1}`;
          inp.id = `name_${i}`;
          inp.style.marginBottom = "8px";
          namesWrap.appendChild(inp);
        }
      }

      function createCricketMarks(numPlayers){
        const marks = [];
        for (let i=0;i<numPlayers;i++){
          const obj = {};
          CRICKET_TARGETS.forEach(t => obj[String(t)] = 0);
          marks.push(obj);
        }
        return marks;
      }

      function createGameFromSetup() {
        const mode = modeEl.value;
        const n = Number(numPlayersEl.value);
        const startScore = Number(startScoreEl.value);

        const names = [];
        for (let i=0;i<n;i++) {
          const v = ($(`name_${i}`)?.value || "").trim();
          names.push(v || `Joueur ${i+1}`);
        }

        const players = names.map(name => ({
          name,
          score: (mode === "x01") ? startScore : 0,
          turns: 0,
          isWinner: false
        }));

        const st = {
          mode,
          startScore,
          players,
          current: 0,
          finished: false,
          history: [],
          undoStack: [],
          currentDarts: [],
          mult: 1
        };

        if (mode === "cricket"){
          st.cricket = { marks: createCricketMarks(n) };
        }

        return st;
      }

      function saveState() {
        if (state) localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }

      function loadState() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        try { return JSON.parse(raw); } catch { return null; }
      }

      function showSetup(){
        setupEl.style.display="";
        gameEl.style.display="none";
        topBadge.textContent="Pr√™t";
      }

      function showGame(){
        setupEl.style.display="none";
        gameEl.style.display="";
      }

      function fmtMode(mode){
        return mode === "x01" ? "X01" : (mode === "countup" ? "Count Up" : "Cricket");
      }

      function pushUndoSnapshot(){
        state.undoStack.unshift(JSON.parse(JSON.stringify({
          players: state.players,
          current: state.current,
          finished: state.finished,
          history: state.history,
          currentDarts: state.currentDarts,
          mult: state.mult,
          cricket: state.cricket
        })));
        if (state.undoStack.length > 50) state.undoStack.pop();
      }

      function setFinished(winnerIndex){
        state.finished = true;
        state.players.forEach((p, i) => p.isWinner = (i===winnerIndex));
      }

      function nextPlayer(){
        if (state.finished) return;
        state.current = (state.current + 1) % state.players.length;
      }

      function escapeHtml(s){
        return String(s)
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      function setMult(m){
        state.mult = m;
        mS.classList.toggle("active", m===1);
        mD.classList.toggle("active", m===2);
        mT.classList.toggle("active", m===3);
        multLabelEl.textContent = m===1 ? "S" : m===2 ? "D" : "T";
        hintEl.textContent = m===1 ? "S = simple (x1)" : m===2 ? "D = double (x2)" : "T = triple (x3)";
        saveState();
      }

      function getTotal(){
        return (state.currentDarts||[]).reduce((s,d)=>s+(d.points||0),0);
      }

      function updateConsole(){
        const darts = state.currentDarts || [];
        dartsCountEl.textContent = darts.length;

        dartsRowEl.innerHTML = "";
        for (let i=0;i<3;i++){
          const d = darts[i];
          const slot = document.createElement("div");
          slot.className = "dartSlot" + (d ? "" : " empty");
          slot.innerHTML = d
            ? `<div><div class="muted">Fl√©chette ${i+1}</div><div class="label">${escapeHtml(d.label)}</div></div>
               <div class="pts">${d.points}</div>`
            : `<div><div class="muted">Fl√©chette ${i+1}</div><div class="label">‚Äî</div></div>
               <div class="pts"></div>`;
          dartsRowEl.appendChild(slot);
        }

        turnTotalEl.textContent = getTotal();

        const full = darts.length >= 3 || state.finished;
        numbersEl.querySelectorAll("button").forEach(b => b.disabled = full || b.dataset.disabled === "1");
        missBtn.disabled = full;
        sbBtn.disabled = full;
        dbBtn.disabled = full;

        backBtn.disabled = darts.length === 0 || state.finished;
        clearBtn.disabled = darts.length === 0 || state.finished;
        applyBtn.disabled = state.finished || darts.length === 0;
        undoBtn.disabled = state.undoStack.length === 0;

        const p = state.players[state.current];
        modeBadge.textContent = `${fmtMode(state.mode)} ‚Ä¢ ${
          state.mode==="x01" ? ("D√©part " + state.startScore) : (state.mode==="cricket" ? "20‚Üí15 + Bull" : "Addition")
        }`;

        topBadge.textContent = state.finished ? "Partie termin√©e" : `√Ä toi : ${p.name}`;
      }

      function addDart(label, points, meta=null){
        if (!state || state.finished) return;
        if (state.currentDarts.length >= 3) return;
        state.currentDarts.push({label, points, meta});
        updateConsole();
        saveState();
      }

      function addNumber(n){
        const m = state.mult || 1;
        if (state.mode === "cricket" && n < 15) return;
        const pts = n * m;
        const prefix = m===1 ? "S" : m===2 ? "D" : "T";
        addDart(`${prefix}${n}`, pts, { type:"num", n, mult:m });
      }

      function backDart(){
        if (!state || state.finished) return;
        state.currentDarts.pop();
        updateConsole();
        saveState();
      }

      function clearDarts(){
        if (!state || state.finished) return;
        state.currentDarts = [];
        updateConsole();
        saveState();
      }

      function renderScoreboard(){
        // Desktop
        scoreboardEl.innerHTML = "";
        state.players.forEach((p, idx) => {
          const div = document.createElement("div");
          div.className = "player" + (idx === state.current ? " active" : "");
          const status = p.isWinner
            ? `<span class="win">GAGNANT</span>`
            : (state.finished ? `<span class="status">Termin√©</span>` : `<span class="status">Tour #${p.turns + 1}</span>`);

          div.innerHTML = `
            <div class="phead">
              <b>${escapeHtml(p.name)}</b>
              ${status}
            </div>
            <div class="big">${p.score}</div>
            <div class="small">Tours jou√©s : ${p.turns}</div>
          `;
          scoreboardEl.appendChild(div);
        });

        // Mobile strip
        mobilePlayersEl.innerHTML = "";
        state.players.forEach((p, idx) => {
          const card = document.createElement("div");
          card.className = "mpCard" + (idx===state.current ? " active" : "");
          const st = p.isWinner ? "WIN" : (state.finished ? "END" : `#${p.turns+1}`);
          card.innerHTML = `
            <div class="mpTop">
              <div class="mpName" title="${escapeHtml(p.name)}">${escapeHtml(p.name)}</div>
              <div>${st}</div>
            </div>
            <div class="mpScore">${p.score}</div>
          `;
          mobilePlayersEl.appendChild(card);
        });
      }

      function renderHistory(){
        historyEl.innerHTML = "";
        if (state.history.length === 0){
          const empty = document.createElement("div");
          empty.className = "hist-item";
          empty.innerHTML = `<span class="muted">Aucun tour pour l‚Äôinstant.</span>`;
          historyEl.appendChild(empty);
          return;
        }

        state.history.slice(0,40).forEach(h => {
          const tag = h.kind === "bust"
            ? `<span class="bust">BUST</span>`
            : h.kind === "win"
              ? `<span class="win">WIN</span>`
              : `<span class="muted">OK</span>`;

          const dartsTxt = h.darts?.length ? h.darts.join(" ‚Ä¢ ") : "‚Äî";
          const item = document.createElement("div");
          item.className = "hist-item";
          item.innerHTML = `
            <div><b>${escapeHtml(h.player)}</b> ‚Äî <b>${escapeHtml(dartsTxt)}</b> ‚Üí total <b>${h.input}</b> ${tag}</div>
            <div class="muted">Avant: ${h.before} ‚Üí Apr√®s: ${h.after}</div>
          `;
          historyEl.appendChild(item);
        });
      }

      // --- Cricket helpers ---
      function markToGlyph(m){
        if (m <= 0) return "";
        if (m === 1) return "/";
        if (m === 2) return "X";
        return "‚óâ";
      }

      function isTargetAllClosed(targetKey){
        const marks = state.cricket.marks;
        for (let i=0;i<marks.length;i++){
          if ((marks[i][targetKey] || 0) < 3) return false;
        }
        return true;
      }

      function playerClosedTarget(playerIdx, targetKey){
        return (state.cricket.marks[playerIdx][targetKey] || 0) >= 3;
      }

      function playerClosedAll(playerIdx){
        const m = state.cricket.marks[playerIdx];
        return CRICKET_TARGETS.every(t => (m[String(t)] || 0) >= 3);
      }

      function cricketApplyHit(playerIdx, hit){
        const t = hit.targetKey;
        if (!CRICKET_TARGETS.map(String).includes(t)) return {addedMarks:0, addedPoints:0};

        const marks = state.cricket.marks;
        const allClosed = isTargetAllClosed(t);
        if (allClosed) return {addedMarks:0, addedPoints:0};

        const before = marks[playerIdx][t] || 0;
        const toAdd = hit.marksAdded;

        let newMarks = before + toAdd;
        let overflow = 0;
        if (newMarks > 3){
          overflow = newMarks - 3;
          newMarks = 3;
        }
        marks[playerIdx][t] = newMarks;

        let points = 0;
        const after = marks[playerIdx][t];
        const wasClosedBefore = before >= 3;
        const isClosedNow = after >= 3;

        if (wasClosedBefore){
          points = toAdd * hit.pointsPerExtraMark;
        } else if (isClosedNow && overflow > 0){
          points = overflow * hit.pointsPerExtraMark;
        }

        if (points > 0){
          state.players[playerIdx].score += points;
        }

        return {addedMarks: Math.min(toAdd, 3-before), addedPoints: points};
      }

      function cricketCheckWin(playerIdx){
        if (!playerClosedAll(playerIdx)) return false;
        const myScore = state.players[playerIdx].score;
        const maxOther = Math.max(...state.players.map((p,i)=> i===playerIdx ? -Infinity : p.score));
        return myScore >= maxOther;
      }

      function renderCricketBoard(){
        if (state.mode !== "cricket"){
          cricketBoardEl.style.display = "none";
          return;
        }
        cricketBoardEl.style.display = "";

        const n = state.players.length;

        cHeaderRowEl.innerHTML = `
          <div class="cHeaderLeft">Cible</div>
          <div class="cHeaderRight" id="cHeaderRight"></div>
        `;
        const right = cHeaderRowEl.querySelector("#cHeaderRight");
        right.style.gridTemplateColumns = `repeat(${n}, minmax(0, 1fr))`;

        state.players.forEach((p) => {
          const c = document.createElement("div");
          c.className = "cHeaderCell";
          c.textContent = p.name;
          c.title = p.name;
          right.appendChild(c);
        });

        cGridEl.innerHTML = "";

        CRICKET_TARGETS.forEach(target => {
          const key = String(target);
          const allClosed = isTargetAllClosed(key);

          const currentIdx = state.current;
          const currentClosed = playerClosedTarget(currentIdx, key);
          const openForCurrent = currentClosed && !allClosed;

          const row = document.createElement("div");
          row.className = "cRow";

          const targetLabel = (target === "B") ? "BULL" : String(target);
          const tag = allClosed
            ? `<span class="openTag allclosed">ALL CLOSED</span>`
            : openForCurrent
              ? `<span class="openTag open">OPEN</span>`
              : `<span class="openTag">‚Äî</span>`;

          const left = document.createElement("div");
          left.className = "cTarget";
          left.innerHTML = `<span>${targetLabel}</span>${tag}`;

          const cells = document.createElement("div");
          cells.className = "cCells";
          cells.style.gridTemplateColumns = `repeat(${n}, minmax(0, 1fr))`;

          state.players.forEach((p, idx) => {
            const m = state.cricket.marks[idx][key] || 0;
            const cell = document.createElement("div");
            cell.className = "cCell" + (idx===state.current ? " active" : "") + (m>=3 ? " closed" : "");
            cell.innerHTML = `<span class="marks">${markToGlyph(Math.min(m,3))}</span>`;
            cell.title = `${p.name} : ${m}/3`;
            cells.appendChild(cell);
          });

          row.appendChild(left);
          row.appendChild(cells);
          cGridEl.appendChild(row);
        });
      }

      function buildNumbers(){
        numbersEl.innerHTML = "";
        for (let n=1;n<=20;n++){
          const b = document.createElement("button");
          b.type = "button";
          b.className = "numBtn";
          b.textContent = n;

          if (state && state.mode === "cricket" && n < 15){
            b.dataset.disabled = "1";
            b.disabled = true;
            b.style.opacity = ".35";
          }

          b.addEventListener("click", ()=>addNumber(n));
          numbersEl.appendChild(b);
        }
      }

      function syncMobilePanels(){
        if (!isMobile()) return;

        // INPUT panel gets the console node
        if (panelInput && consoleDesktop && consoleDesktop.parentElement !== panelInput){
          panelInput.innerHTML = "";
          panelInput.appendChild(consoleDesktop);
        }

        // CRICKET panel
        panelCricket.innerHTML = "";
        if (state && state.mode === "cricket"){
          panelCricket.appendChild(cricketBoardDesktop);
        } else {
          panelCricket.innerHTML = `<div class="muted" style="padding:10px">Le mode Cricket n‚Äôest pas s√©lectionn√©.</div>`;
        }

        // HISTORY panel
        panelHistory.innerHTML = "";
        const historyBlock = document.createElement("div");
        historyBlock.className = "card";
        historyBlock.style.background = "rgba(255,255,255,.44)";
        historyBlock.style.height = "100%";
        historyBlock.style.display = "flex";
        historyBlock.style.flexDirection = "column";
        historyBlock.innerHTML = `
          <b>Historique</b>
          <div class="muted" style="margin:6px 0 10px">Derniers tours en haut</div>
        `;

        const h = historyEl; // reuse
        h.style.height = "100%";
        h.style.maxHeight = "none";

        historyBlock.appendChild(h);
        panelHistory.appendChild(historyBlock);
      }

      function setMobileView(view){
        mobileView = view;
        tabInput.classList.toggle("active", view==="input");
        tabCricket.classList.toggle("active", view==="cricket");
        tabHistory.classList.toggle("active", view==="history");

        panelInput.classList.toggle("active", view==="input");
        panelCricket.classList.toggle("active", view==="cricket");
        panelHistory.classList.toggle("active", view==="history");

        saveState();
      }

      function render(){
        if (!state) return;

        renderScoreboard();
        const p = state.players[state.current];
        turnLabelEl.textContent = state.finished ? "Partie termin√©e" : `üéØ ${p.name}, √† toi de jouer !`;

        renderCricketBoard();
        renderHistory();
        setMult(state.mult || 1);
        updateConsole();

        if (state.mode === "x01"){
          rulesNoteEl.innerHTML = `X01 : si le total fait passer sous 0 ‚Üí <b>bust</b>.`;
        } else if (state.mode === "countup"){
          rulesNoteEl.textContent = `Count Up : addition simple.`;
        } else {
          rulesNoteEl.innerHTML = `Cricket : fermer √† 3 marques.`;
        }

        if (isMobile()){
          syncMobilePanels();
          setMobileView(mobileView || "input");
        }

        saveState();
      }

      function applyTurn(){
        if (!state || state.finished) return;

        const idx = state.current;
        const p = state.players[idx];
        pushUndoSnapshot();

        const before = p.score;
        let after = before;
        let kind = "ok";
        const darts = (state.currentDarts||[]).map(d=>d.label);

        if (state.mode === "x01"){
          const val = getTotal();
          after = before - val;
          if (after < 0){
            after = before;
            kind = "bust";
          } else {
            p.score = after;
            p.turns += 1;
            if (after === 0){
              kind = "win";
              setFinished(idx);
            }
          }
          state.history.unshift({ player:p.name, input: val, darts, before, after, kind, at: Date.now() });
          state.currentDarts = [];
          if (!state.finished){
            if (kind !== "bust") nextPlayer();
          }
          render();
          return;
        }

        if (state.mode === "countup"){
          const val = getTotal();
          after = before + val;
          p.score = after;
          p.turns += 1;
          state.history.unshift({ player:p.name, input: val, darts, before, after, kind, at: Date.now() });
          state.currentDarts = [];
          nextPlayer();
          render();
          return;
        }

        // Cricket
        let turnPointsGained = 0;
        for (const d of (state.currentDarts||[])){
          if (d.label === "MISS") continue;

          if (d.label === "SB"){
            const res = cricketApplyHit(idx, { targetKey: "B", marksAdded: 1, pointsPerExtraMark: BULL_POINTS_PER_MARK });
            turnPointsGained += res.addedPoints;
            continue;
          }

          if (d.label === "DB"){
            const res = cricketApplyHit(idx, { targetKey: "B", marksAdded: 2, pointsPerExtraMark: BULL_POINTS_PER_MARK });
            turnPointsGained += res.addedPoints;
            continue;
          }

          if (d.meta && d.meta.type === "num"){
            const n = d.meta.n;
            const mult = d.meta.mult;
            if (n < 15 || n > 20) continue;
            const res = cricketApplyHit(idx, { targetKey: String(n), marksAdded: mult, pointsPerExtraMark: n });
            turnPointsGained += res.addedPoints;
          }
        }

        p.turns += 1;
        after = p.score;

        if (cricketCheckWin(idx)){
          kind = "win";
          setFinished(idx);
        }

        state.history.unshift({ player: p.name, input: turnPointsGained, darts, before, after, kind, at: Date.now() });
        state.currentDarts = [];

        if (!state.finished) nextPlayer();
        render();
      }

      function undo(){
        if (!state || state.undoStack.length === 0) return;
        const snap = state.undoStack.shift();
        state.players = snap.players;
        state.current = snap.current;
        state.finished = snap.finished;
        state.history = snap.history;
        state.currentDarts = snap.currentDarts || [];
        state.mult = snap.mult || 1;
        state.cricket = snap.cricket;
        render();
      }

      function resetGameKeepSetup(){
        const mode = state.mode;
        const startScore = state.startScore;

        state.players = state.players.map(p => ({
          name: p.name,
          score: mode === "x01" ? startScore : 0,
          turns: 0,
          isWinner: false
        }));

        state.current = 0;
        state.finished = false;
        state.history = [];
        state.undoStack = [];
        state.currentDarts = [];
        state.mult = 1;

        if (mode === "cricket"){
          state.cricket = { marks: createCricketMarks(state.players.length) };
        } else {
          delete state.cricket;
        }

        render();
      }

      // Setup events
      numPlayersEl.addEventListener("change", renderNameInputs);
      modeEl.addEventListener("change", () => {
        startScoreEl.disabled = (modeEl.value !== "x01");
      });

      startBtn.addEventListener("click", () => {
        state = createGameFromSetup();
        showGame();
        buildNumbers();
        mobileView = "input";
        render();
      });

      loadBtn.addEventListener("click", () => {
        const loaded = loadState();
        if (!loaded) {
          alert("Aucune partie sauvegard√©e trouv√©e.");
          return;
        }
        state = loaded;
        if (state.mode === "cricket" && (!state.cricket || !state.cricket.marks)){
          state.cricket = { marks: createCricketMarks(state.players.length) };
        }
        showGame();
        buildNumbers();
        render();
      });

      // Game events
      mS.addEventListener("click", ()=>setMult(1));
      mD.addEventListener("click", ()=>setMult(2));
      mT.addEventListener("click", ()=>setMult(3));

      missBtn.addEventListener("click", ()=>addDart("MISS", 0, {type:"miss"}));
      sbBtn.addEventListener("click", ()=>addDart("SB", 25, {type:"bull", marks:1}));
      dbBtn.addEventListener("click", ()=>addDart("DB", 50, {type:"bull", marks:2}));

      backBtn.addEventListener("click", backDart);
      clearBtn.addEventListener("click", clearDarts);

      applyBtn.addEventListener("click", applyTurn);
      undoBtn.addEventListener("click", undo);

      resetBtn.addEventListener("click", () => {
        if (!confirm("R√©initialiser la partie ?")) return;
        resetGameKeepSetup();
      });

      newGameBtn.addEventListener("click", () => {
        if (!confirm("Revenir √† l'√©cran de configuration ?")) return;
        state = null;
        showSetup();
      });

      // Mobile tabs
      tabInput.addEventListener("click", ()=>setMobileView("input"));
      tabCricket.addEventListener("click", ()=>setMobileView("cricket"));
      tabHistory.addEventListener("click", ()=>setMobileView("history"));

      // Keyboard shortcuts
      window.addEventListener("keydown", (e) => {
        if (!state || setupEl.style.display !== "none") return;

        if (e.key === "Enter") {
          e.preventDefault();
          if (!applyBtn.disabled) applyTurn();
        }
        if (e.key === "Backspace") {
          e.preventDefault();
          backDart();
        }
        if (e.key === "Escape") {
          e.preventDefault();
          clearDarts();
        }
      });

      window.addEventListener("resize", () => {
        if (!state) return;
        render();
      });

      // init
      renderNameInputs();
      startScoreEl.disabled = (modeEl.value !== "x01");
      showSetup();
    })();
  </script>

  <!-- Service Worker -->
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js");
    }
  </script>
</body>
</html>






